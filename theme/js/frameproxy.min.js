(function(e){var b={};var c=0;b.functions=["jQuery.ajax","jQuery.get","jQuery.post","jQuery.getJSON"];b.global=window||global;b.ppath=function(f,j,g){if(typeof f=="string"){g=j;j=f;f=b.global;if(!b.global){throw"window not defined, specify frameproxy.global"}}var i=j.split("."),k=f;if(typeof g=="undefined"){for(var h=0;h<i.length-1;h++){if(typeof k!=="object"){k=null;break}k=k[i[h]]}return k?{obj:k,value:k[i[i.length-1]],name:i[i.length-1]}:{}}else{for(var h=0;h<i.length;h++){if(typeof k=="undefined"||k===null){break}k[i[h]]=(h==i.length-1?g:{});k=k[i[h]]}}};b.stripFunctions=function(h){var g=h;if(typeof h=="object"){if(h instanceof Array){g=[];for(var f=h.length;f>=0;f--){if(typeof h[f]=="function"){g[f]=null}else{if(typeof h[f]=="object"){g[f]=b.stripFunctions(h[f])}}}}else{g={}}for(var j in h){if(typeof h[j]!="function"){if(typeof h[j]=="object"){g[j]=b.stripFunctions(h[j])}else{g[j]=h[j]}}}}return g};b.message={pack:function(g,f){return b.stripFunctions(g)},unpack:function(g,f){return g}};b.ProxyClient=function d(g,f){if(!window.postMessage){throw"window.postMessage not supported on this browser"}if(typeof jQuery=="undefined"){throw"jQuery is required"}else{this.password=f;this.deferreds={};this.proxyWindow=null;if(typeof g=="object"&&typeof g.postMessage=="function"){this.proxyWindow=g;(function(h){jQuery(function(){console.log("frameproxy client ready");jQuery(h).trigger("ready")})})(this)}else{this.iframe=document.createElement("iframe");this.iframe.src=g;this.iframe.style.display="none";(function(i,h){jQuery(function(){jQuery(i).load(function(){h.proxyWindow=i.contentWindow;console.log("frameproxy client ready");jQuery(h).trigger("ready")});jQuery("body").append(i)})})(this.iframe,this)}(function(h){window.addEventListener("message",function(l){if(l.source!==h.proxyWindow){return}var m,i;try{var k=b.message.unpack(l.data);if(k.id&&(i=h.deferreds[k.id])){if(k.error){i.reject.apply(i,k.args)}else{if(typeof k.result!="undefined"){i.resolve.apply(i,[k.result])}else{i.resolve.apply(i,k.args)}}}}catch(j){if(!i.isRejected()){i.reject(j)}}finally{if(m){delete h.deferreds[m]}}})})(this)}};b.ProxyClient.prototype.remote=function(h,g){c++;var j="_"+c,f=this.deferreds[j]=jQuery.Deferred();var i=b.message.pack({id:j,expr:h,args:g});if(this.password){i.password=this.password}this.proxyWindow.postMessage(i,"*");return f.promise()};b.ProxyClient.prototype.ready=function(f){e(this).bind("ready",f);return this};b.ProxyClient.prototype.wrapAll=function(){var f=Array.prototype.slice.apply(arguments);f.push.apply(f,b.functions);return this.wrap.apply(this,f)};b.ProxyClient.prototype.wrap=function(g){var m=function(i,n){return function(){return i.remote(n,Array.prototype.slice.apply(arguments))}};var h=(g===true);for(var f=0;f<arguments.length;f++){var l=arguments[f];if(typeof l=="string"){var k=m(this,l);b.ppath(this,l,k);if(h){var j=b.ppath(l);if(j.obj){j.obj[j.name]=k}}}}return this};b.ProxyServer=function a(f){if(!window.postMessage){throw"window.postMessage not supported on this browser"}if(typeof jQuery=="undefined"){throw"jQuery is required"}this.options=jQuery.extend(true,{},b.ProxyServer.options,f)};b.ProxyServer.options={domain:document?(document.location.protocol+"//"+document.location.host):"http://localhost",uri:"*",password:null,expressions:Array.prototype.slice.apply(b.functions)};b.ProxyServer.prototype.listen=function(){var f=function(l,j){if(!j){return true}var k=(j instanceof Array?j:[j]);for(var g=0;g<k.length;g++){var h=k[g];if(h==="*"){return true}if(h instanceof RegExp){if(h.test(l)){return true}}else{if(typeof h=="function"){if(h(l)){return true}}else{if(h===l){return true}}}}return false};(function(g){window.addEventListener("message",function(q){var i=-1;try{var o=b.message.unpack(q.data);if(g.password){if(q.data.password!==g.password){throw"request rejected: invalid password"}}if(!f(q.domain,g.domain)){throw'request rejected: invalid domain "'+q.domain+'"'}if(!f(q.uri,g.uri)){throw'request rejected: invalid domain "'+q.domain+'"'}if(typeof o.id=="undefined"){throw"no id specified"}if(!o.expr){throw"no expr specified"}var h=false,i=o.id;if(!f(o.expr,g.expressions)){throw'request rejected: invalid expr "'+o.expr+'"'}var r;var j=b.ppath(o.expr);if(j.obj){if(typeof j.value=="function"){r=j.value.apply(j.obj,o.args)}else{r=j.value}}if(r&&typeof r.then=="function"){var n=function(p){return function(){var s=b.message.pack({ok:true,id:p,args:Array.prototype.slice.apply(arguments)});q.source.postMessage(s,"*")}}(i);var l=function(p){return function(){var s=b.message.pack({error:"deferred failed",id:p,args:Array.prototype.slice.apply(arguments)});q.source.postMessage(s,"*")}}(i);r.then(n,l)}else{var k=b.message.pack({ok:true,id:i,result:typeof r=="undefined"?null:r});q.source.postMessage(k,"*")}}catch(m){console.error("error processing remote call: "+m);var k=b.message.pack({id:i,error:m});q.source.postMessage(k,"*")}})})(this.options);console.log("frameproxy server listening");e(this).trigger("ready");return this};b.ProxyServer.prototype.ready=function(f){e(this).bind("ready",f);return this};if(typeof window!=="undefined"){window.frameproxy=b}else{if(typeof exports!="undefined"){exports.frameproxy=b}}})(jQuery);